{"ast":null,"code":"import _regeneratorRuntime from\"/Users/prov/Documents/Front-end projects/netflix-build-clone/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/prov/Documents/Front-end projects/netflix-build-clone/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/Users/prov/Documents/Front-end projects/netflix-build-clone/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useEffect,useState}from'react';import{useSelector}from\"react-redux\";import{selectUser}from\"../features/userSlice\";import db from'../firebase';import\"./PlansScreen.css\";import{loadStripe}from\"@stripe/stripe-js\";import{getRoles}from'@testing-library/react';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";function PlansScreen(){var _useState=useState([]),_useState2=_slicedToArray(_useState,2),products=_useState2[0],setProducts=_useState2[1];var user=useSelector(selectUser);var _useState3=useState(null),_useState4=_slicedToArray(_useState3,2),subscription=_useState4[0],setSubscription=_useState4[1];useEffect(function(){db.collection(\"customers\").doc(user.uid).collection('subscriptions').get().then(function(querySnapshot){querySnapshot.forEach(/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(subscription){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:setSubscription({role:subscription.data().role,current_period_end:subscription.data().current_period_end.seconds,current_period_start:subscription.data().current_period_start.seconds});case 1:case\"end\":return _context.stop();}}},_callee);}));return function(_x){return _ref.apply(this,arguments);};}());});},[user.uid]);useEffect(function(){db.collection(\"products\").where(\"active\",\"==\",true).get().then(function(querySnapshot){var products={};querySnapshot.forEach(/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(productDoc){var priceSnap;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:products[productDoc.id]=productDoc.data();_context2.next=3;return productDoc.ref.collection(\"prices\").get();case 3:priceSnap=_context2.sent;priceSnap.docs.forEach(function(price){products[productDoc.id].prices={priceId:price.id,priceData:price.data()};});case 5:case\"end\":return _context2.stop();}}},_callee2);}));return function(_x2){return _ref2.apply(this,arguments);};}());setProducts(products);});},[]);console.log(products);console.log(subscription);var loadCheckout=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(priceId){var docRef;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.next=2;return db.collection(\"customers\").doc(user.uid).collection(\"checkout_sessions\").add({price:priceId,success_url:window.location.origin,cancel_url:window.location.origin});case 2:docRef=_context4.sent;console.log(\"working1\");docRef.onSnapshot(/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(snap){var _snap$data,error,sessionId,stripe;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_snap$data=snap.data(),error=_snap$data.error,sessionId=_snap$data.sessionId;if(error){console.log(\"working2\");alert(\"An error occured: \".concat(error.message));}if(!sessionId){_context3.next=8;break;}console.log(\"working3\");_context3.next=6;return loadStripe(\"pk_test_51INAeZC4PbIiBgBKOLJz4brw1qormmtWvafDPfGBG8an3OX3V5FrCsGKvU2cDbZHVJ5X7jE3rllw5Cfy5gAkLGQc00nvB1AXUI\");case 6:stripe=_context3.sent;stripe.redirectToCheckout({sessionId:sessionId});case 8:case\"end\":return _context3.stop();}}},_callee3);}));return function(_x4){return _ref4.apply(this,arguments);};}());case 5:case\"end\":return _context4.stop();}}},_callee4);}));return function loadCheckout(_x3){return _ref3.apply(this,arguments);};}();return/*#__PURE__*/_jsxs(\"div\",{className:\"plansScreen\",children:[/*#__PURE__*/_jsx(\"br\",{}),subscription&&/*#__PURE__*/_jsxs(\"p\",{children:[\"Renewal date: \",\" \",new Date((subscription===null||subscription===void 0?void 0:subscription.current_period_end)*1000).toLocaleDateString()]}),Object.entries(products).map(function(_ref5){var _productData$name;var _ref6=_slicedToArray(_ref5,2),productId=_ref6[0],productData=_ref6[1];var isCurrentPackage=(_productData$name=productData.name)===null||_productData$name===void 0?void 0:_productData$name.toLowerCase().includes(subscription===null||subscription===void 0?void 0:subscription.role);return/*#__PURE__*/_jsxs(\"div\",{className:\"\\n                        \".concat(isCurrentPackage&&\"plansScreen_plan--disabled\",\" plansScreen_plan\"),children:[/*#__PURE__*/_jsxs(\"div\",{className:\"plansScreen_info\",children:[/*#__PURE__*/_jsx(\"h5\",{children:productData.name}),/*#__PURE__*/_jsx(\"h6\",{children:productData.description})]}),/*#__PURE__*/_jsx(\"button\",{onClick:function onClick(){return!isCurrentPackage&&loadCheckout(productData.prices.priceId);},children:isCurrentPackage?'Current Package':'Subscribe'})]},productId);})]});}export default PlansScreen;","map":{"version":3,"sources":["/Users/prov/Documents/Front-end projects/netflix-build-clone/src/screens/PlansScreen.js"],"names":["React","useEffect","useState","useSelector","selectUser","db","loadStripe","getRoles","PlansScreen","products","setProducts","user","subscription","setSubscription","collection","doc","uid","get","then","querySnapshot","forEach","role","data","current_period_end","seconds","current_period_start","where","productDoc","id","ref","priceSnap","docs","price","prices","priceId","priceData","console","log","loadCheckout","add","success_url","window","location","origin","cancel_url","docRef","onSnapshot","snap","error","sessionId","alert","message","stripe","redirectToCheckout","Date","toLocaleDateString","Object","entries","map","productId","productData","isCurrentPackage","name","toLowerCase","includes","description"],"mappings":"0aAAA,MAAOA,CAAAA,KAAP,EAAgBC,SAAhB,CAA2BC,QAA3B,KAA2C,OAA3C,CACA,OAASC,WAAT,KAA4B,aAA5B,CACA,OAAQC,UAAR,KAAyB,uBAAzB,CACA,MAAOC,CAAAA,EAAP,KAAe,aAAf,CACA,MAAO,mBAAP,CACA,OAASC,UAAT,KAA2B,mBAA3B,CACA,OAASC,QAAT,KAAyB,wBAAzB,C,wFAEA,QAASC,CAAAA,WAAT,EAAuB,eAEaN,QAAQ,CAAC,EAAD,CAFrB,wCAEZO,QAFY,eAEFC,WAFE,eAInB,GAAMC,CAAAA,IAAI,CAAGR,WAAW,CAACC,UAAD,CAAxB,CAJmB,eAMqBF,QAAQ,CAAC,IAAD,CAN7B,yCAMZU,YANY,eAMEC,eANF,eAQnBZ,SAAS,CAAC,UAAM,CACZI,EAAE,CAACS,UAAH,CAAc,WAAd,EACKC,GADL,CACSJ,IAAI,CAACK,GADd,EAEKF,UAFL,CAEgB,eAFhB,EAGKG,GAHL,GAIKC,IAJL,CAIU,SAAAC,aAAa,CAAI,CACnBA,aAAa,CAACC,OAAd,0FAAsB,iBAAMR,YAAN,kHAClBC,eAAe,CAAC,CACZQ,IAAI,CAACT,YAAY,CAACU,IAAb,GAAoBD,IADb,CAEZE,kBAAkB,CAAGX,YAAY,CAACU,IAAb,GAAoBC,kBAApB,CAAuCC,OAFhD,CAGRC,oBAAoB,CAAEb,YAAY,CAACU,IAAb,GAAoBG,oBAApB,CAAyCD,OAHvD,CAAD,CAAf,CADkB,sDAAtB,gEASP,CAdD,EAeH,CAhBQ,CAgBP,CAACb,IAAI,CAACK,GAAN,CAhBO,CAAT,CAkBAf,SAAS,CAAC,UAAM,CACZI,EAAE,CAACS,UAAH,CAAc,UAAd,EAA0BY,KAA1B,CAAgC,QAAhC,CAAyC,IAAzC,CAA+C,IAA/C,EACKT,GADL,GAEKC,IAFL,CAEU,SAACC,aAAD,CAAmB,CACrB,GAAMV,CAAAA,QAAQ,CAAG,EAAjB,CACAU,aAAa,CAACC,OAAd,2FAAsB,kBAAOO,UAAP,oIAClBlB,QAAQ,CAACkB,UAAU,CAACC,EAAZ,CAAR,CAA0BD,UAAU,CAACL,IAAX,EAA1B,CADkB,uBAEMK,CAAAA,UAAU,CAACE,GAAX,CAAef,UAAf,CACnB,QADmB,EACTG,GADS,EAFN,QAEZa,SAFY,gBAIlBA,SAAS,CAACC,IAAV,CAAeX,OAAf,CAAuB,SAACY,KAAD,CAAU,CAC7BvB,QAAQ,CAACkB,UAAU,CAACC,EAAZ,CAAR,CAAwBK,MAAxB,CAAiC,CAC7BC,OAAO,CAAEF,KAAK,CAACJ,EADc,CAE7BO,SAAS,CAAEH,KAAK,CAACV,IAAN,EAFkB,CAAjC,CAIC,CALL,EAJkB,wDAAtB,kEAWAZ,WAAW,CAACD,QAAD,CAAX,CACP,CAhBD,EAiBH,CAlBQ,CAkBN,EAlBM,CAAT,CAmBA2B,OAAO,CAACC,GAAR,CAAY5B,QAAZ,EACC2B,OAAO,CAACC,GAAR,CAAYzB,YAAZ,EAGG,GAAM0B,CAAAA,YAAY,2FAAG,kBAAOJ,OAAP,wJACI7B,CAAAA,EAAE,CAClBS,UADgB,CACL,WADK,EAEhBC,GAFgB,CAEZJ,IAAI,CAACK,GAFO,EAGhBF,UAHgB,CAGL,mBAHK,EAIhByB,GAJgB,CAIZ,CACDP,KAAK,CAAEE,OADN,CAEDM,WAAW,CAAEC,MAAM,CAACC,QAAP,CAAgBC,MAF5B,CAGDC,UAAU,CAACH,MAAM,CAACC,QAAP,CAAgBC,MAH1B,CAJY,CADJ,QACXE,MADW,gBAUTT,OAAO,CAACC,GAAR,CAAY,UAAZ,EAERQ,MAAM,CAACC,UAAP,2FAAkB,kBAAMC,IAAN,uKACeA,IAAI,CAACzB,IAAL,EADf,CACN0B,KADM,YACNA,KADM,CACCC,SADD,YACCA,SADD,CAGd,GAAID,KAAJ,CAAW,CACPZ,OAAO,CAACC,GAAR,CAAY,UAAZ,EAEAa,KAAK,6BAAsBF,KAAK,CAACG,OAA5B,EAAL,CACH,CAPa,IASVF,SATU,0BAUVb,OAAO,CAACC,GAAR,CAAY,UAAZ,EAVU,uBAaW/B,CAAAA,UAAU,CAC3B,6GAD2B,CAbrB,QAaJ8C,MAbI,gBAeVA,MAAM,CAACC,kBAAP,CAA0B,CAAEJ,SAAS,CAATA,SAAF,CAA1B,EAfU,wDAAlB,kEAZiB,wDAAH,kBAAZX,CAAAA,YAAY,8CAAlB,CAiCJ,mBACI,aAAK,SAAS,CAAC,aAAf,wBACI,aADJ,CAEK1B,YAAY,eACb,sCACuB,GADvB,CAES,GAAI0C,CAAAA,IAAJ,CACD,CAAA1C,YAAY,OAAZ,EAAAA,YAAY,SAAZ,QAAAA,YAAY,CAAEW,kBAAd,EAAmC,IADlC,EAECgC,kBAFD,EAFT,GAHJ,CAUKC,MAAM,CAACC,OAAP,CAAehD,QAAf,EAAyBiD,GAAzB,CAA6B,eAA8B,yDAA5BC,SAA4B,UAAjBC,WAAiB,UAExD,GAAMC,CAAAA,gBAAgB,oBAAGD,WAAW,CAACE,IAAf,4CAAG,kBAAkBC,WAAlB,GAAgCC,QAAhC,CAAyCpD,YAAzC,SAAyCA,YAAzC,iBAAyCA,YAAY,CAAES,IAAvD,CAAzB,CAEA,mBACI,aAEI,SAAS,qCACPwC,gBAAgB,EAAI,4BADb,qBAFb,wBAMI,aAAK,SAAS,CAAC,kBAAf,wBACI,oBAAKD,WAAW,CAACE,IAAjB,EADJ,cAEI,oBAAKF,WAAW,CAACK,WAAjB,EAFJ,GANJ,cAUI,eAAQ,OAAO,CAAE,yBAAK,CAACJ,gBAAD,EAAqBvB,YAAY,CAACsB,WAAW,CAAC3B,MAAZ,CAAmBC,OAApB,CAAtC,EAAjB,UACK2B,gBAAgB,CAAG,iBAAH,CAAuB,WAD5C,EAVJ,GACSF,SADT,CADJ,CAgBH,CApBA,CAVL,GADJ,CAmCH,CAED,cAAenD,CAAAA,WAAf","sourcesContent":["import React, { useEffect, useState } from 'react'\nimport { useSelector } from \"react-redux\"\nimport {selectUser} from \"../features/userSlice\"\nimport db from '../firebase'\nimport \"./PlansScreen.css\"\nimport { loadStripe } from \"@stripe/stripe-js\";\nimport { getRoles } from '@testing-library/react'\n\nfunction PlansScreen() {\n\n    const [products, setProducts] = useState([]);\n    \n    const user = useSelector(selectUser)\n    \n    const [subscription, setSubscription] = useState(null)\n    \n    useEffect(() => {\n        db.collection(\"customers\")\n            .doc(user.uid)\n            .collection('subscriptions')\n            .get()\n            .then(querySnapshot => {\n                querySnapshot.forEach(async subscription => {\n                    setSubscription({\n                        role:subscription.data().role,\n                        current_period_end : subscription.data().current_period_end.seconds,\n                            current_period_start: subscription.data().current_period_start.seconds,\n                        \n                    })\n                    \n            })\n        })\n    },[user.uid])\n\n    useEffect(() => {\n        db.collection(\"products\").where(\"active\",\"==\", true)\n            .get()\n            .then((querySnapshot) => {\n                const products = {}\n                querySnapshot.forEach(async (productDoc) => {\n                    products[productDoc.id] = productDoc.data()\n                    const priceSnap = await productDoc.ref.collection\n                        (\"prices\").get()\n                    priceSnap.docs.forEach((price) =>{\n                        products[productDoc.id].prices = {\n                            priceId: price.id,\n                            priceData: price.data()\n                        }\n                        })\n                })\n                setProducts(products)\n        })\n    }, [])\n    console.log(products)\n     console.log(subscription)\n\n\n        const loadCheckout = async (priceId) => { \n            const docRef = await db\n                .collection(\"customers\")\n                .doc(user.uid)\n                .collection(\"checkout_sessions\")\n                .add({\n                    price: priceId,\n                    success_url: window.location.origin,\n                    cancel_url:window.location.origin,\n                })\n                    console.log(\"working1\")\n            \n            docRef.onSnapshot(async(snap) => {\n                const { error, sessionId } = snap.data();\n                \n                if (error) {\n                    console.log(\"working2\")\n                    \n                    alert(`An error occured: ${error.message}`)\n                }\n\n                if (sessionId) {\n                    console.log(\"working3\")\n\n\n                    const stripe = await loadStripe(\n                        \"pk_test_51INAeZC4PbIiBgBKOLJz4brw1qormmtWvafDPfGBG8an3OX3V5FrCsGKvU2cDbZHVJ5X7jE3rllw5Cfy5gAkLGQc00nvB1AXUI\")\n                    stripe.redirectToCheckout({ sessionId })\n                    \n                }\n            })\n    }\n\n    return (\n        <div className=\"plansScreen\">\n            <br/>\n            {subscription && (\n            <p>\n                    Renewal date: {\" \"}\n                    {new Date(\n                    subscription?.current_period_end * 1000\n                    ).toLocaleDateString()}\n            </p>\n            )}\n            {Object.entries(products).map(([productId, productData]) => {\n                \n                const isCurrentPackage = productData.name?.toLowerCase().includes(subscription?.role)\n\n                return (\n                    <div\n                        key={productId}\n                        className={`\n                        ${isCurrentPackage && \"plansScreen_plan--disabled\"\n                            } plansScreen_plan`}\n                    >\n                        <div className=\"plansScreen_info\">\n                            <h5>{productData.name}</h5>\n                            <h6>{productData.description}</h6>\n                        </div>\n                        <button onClick={()=> !isCurrentPackage && loadCheckout(productData.prices.priceId)}>\n                            {isCurrentPackage ? 'Current Package' : 'Subscribe'}\n                        </button>\n                    </div>\n                )\n            })}\n            \n        </div>\n    )\n}\n\nexport default PlansScreen\n"]},"metadata":{},"sourceType":"module"}